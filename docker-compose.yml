version: '3.8'

networks:
  planoz-net:
    driver: bridge

services:

  redis-node-1:
    image: redis:7-alpine
    container_name: redis-node-1
    command: ["redis-server", "--port", "6379", "--cluster-enabled", "yes", "--cluster-config-file", "nodes.conf", "--cluster-node-timeout", "5000", "--appendonly", "yes"]
    networks:
      - planoz-net
    ports:
      - "6379:6379"

  redis-node-2:
    image: redis:7-alpine
    container_name: redis-node-2
    command: ["redis-server", "--port", "6379", "--cluster-enabled", "yes", "--cluster-config-file", "nodes.conf", "--cluster-node-timeout", "5000", "--appendonly", "yes"]
    networks:
      - planoz-net
    ports:
      - "6380:6379"

  redis-node-3:
    image: redis:7-alpine
    container_name: redis-node-3
    command: ["redis-server", "--port", "6379", "--cluster-enabled", "yes", "--cluster-config-file", "nodes.conf", "--cluster-node-timeout", "5000", "--appendonly", "yes"]
    networks:
      - planoz-net
    ports:
      - "6381:6379"

  redis-cluster-init:
    image: redis:7-alpine
    depends_on:
      - redis-node-1
      - redis-node-2
      - redis-node-3
    networks:
      - planoz-net
    command: >
      sh -c "sleep 5;
      echo 'yes' | redis-cli --cluster create redis-node-1:6379 redis-node-2:6379 redis-node-3:6379 --cluster-replicas 0;
      sleep infinity"

  server1:
    build:
      context: .
      dockerfile: server/Dockerfile
    container_name: server1
    hostname: server1
    depends_on:
      - redis-cluster-init
    ports:
      - "9090:9090"     
      - "8083:8083/udp" 
    environment:
      - SERVER_ID=server1
      - API_PORT=9090
      - UDP_PORT=8083
      - REDIS_ADDRS=redis-node-1:6379,redis-node-2:6379,redis-node-3:6379
      - SERVER_LIST=server1:9090,server2:9090,server3:9090  # Usar portas internas!
      - EXTERNAL_PORT=9090
    networks:
      - planoz-net

  server2:
    build:
      context: .
      dockerfile: server/Dockerfile
    container_name: server2
    hostname: server2
    depends_on:
      - server1
    ports:
      - "9091:9090"     
      - "8084:8083/udp" 
    environment:
      - SERVER_ID=server2
      - API_PORT=9090  # Interna
      - UDP_PORT=8083
      - REDIS_ADDRS=redis-node-1:6379,redis-node-2:6379,redis-node-3:6379
      - SERVER_LIST=server1:9090,server2:9090,server3:9090  # Todas usam porta 9090 internamente
      - EXTERNAL_PORT=9091  # Externa para acesso de fora
    networks:
      - planoz-net

  server3:
    build:
      context: .
      dockerfile: server/Dockerfile
    container_name: server3
    hostname: server3
    depends_on:
      - server1
    ports:
      - "9092:9090"
      - "8085:8083/udp"
    environment:
      - SERVER_ID=server3
      - API_PORT=9090  # Interna
      - UDP_PORT=8083
      - REDIS_ADDRS=redis-node-1:6379,redis-node-2:6379,redis-node-3:6379
      - SERVER_LIST=server1:9090,server2:9090,server3:9090  # Todas usam porta 9090 internamente
      - EXTERNAL_PORT=9092  # Externa para acesso de fora
    networks:
      - planoz-net

  client:
    build:
      context: .
      dockerfile: client/Dockerfile
    stdin_open: true 
    tty: true
    networks:
      - planoz-net
    environment:
      - SERVER_API=server1:9090
      - REDIS_ADDRS=redis-node-1:6379,redis-node-2:6379,redis-node-3:6379